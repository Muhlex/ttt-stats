var S=Object.defineProperty,U=Object.defineProperties;var B=Object.getOwnPropertyDescriptors;var E=Object.getOwnPropertySymbols;var F=Object.prototype.hasOwnProperty,K=Object.prototype.propertyIsEnumerable;var N=(d,o,u)=>o in d?S(d,o,{enumerable:!0,configurable:!0,writable:!0,value:u}):d[o]=u,R=(d,o)=>{for(var u in o||(o={}))F.call(o,u)&&N(d,u,o[u]);if(E)for(var u of E(o))K.call(o,u)&&N(d,u,o[u]);return d},y=(d,o)=>U(d,B(o));(function(){"use strict";function d(t,e){const n=parseInt(e);if(n===0)throw new Error("Cannot chunk into chunks of 0 length.");const s=[];for(let r=0;r<t.length;r+=n)s.push(t.slice(r,r+n));return s}async function o(t){return await(await fetch(t,{cache:"no-cache"})).text()}function u(t){return t.replaceAll(`\r
`,`
`)}function M(t){return t.replace(/\^[\d:;]/g,"")}function v(t){const e=new Map,n=[...t.matchAll(/\n *\d*:\d* J;(.*?);.*?;(.*)/g)];for(const[,s,r]of n)e.set(s,{guid:s,name:M(r).trim(),isBot:s.length!==16});return e}function g(t){const[e,n]=t.split(":");return Number(e)*60+Number(n)}function k(t){return t.match(/\d*:\d* InitGame(?:.|\n)*?ShutdownGame/g)}function b(t,e){return t.map(n=>{const s=x(n,e);return{date:O(n),players:s,outcome:C(n),events:I(n,s,e)}})}function L(t){return t.filter(({players:e,outcome:n})=>e.length&&n).filter(({players:e})=>e.every(({isBot:n})=>!n))}function O(t){const e=t.match(/\n *\d*:\d* TTT_ROUND_START;(\d+)/);return e?new Date(Number(e[1])*1e3):null}function x(t,e){const n=t.match(/\n *\d*:\d* TTT_PLAYERS;(.*)\n/);return n?n[1].split(";").map(s=>{const[,r,c]=s.match(/(.*)<(.*)>/);return y(R({},e.get(r)),{role:c})}):[]}function C(t){const e=t.match(/\n *\d*:\d* TTT_ROUND_END;(.*?);(.*?);(.*);*/);if(!e)return null;const[,n,s,r]=e;return{winner:n,reason:s,roundLength:Number(r)}}function I(t,e,n){const s=t.match(/\n *(\d*:\d*) TTT_ROUND_START.*\n((?:.|\n)*?)\n *(\d*:\d*) TTT_ROUND_END/);if(!s)return null;const[,r,c,i]=s,l=g(r),f=g(i),m=c.split(`
`).map(a=>P(a,e)||A(a,e)||G(a,e,n)||null).filter(a=>a).flat(1);return[{type:"round-start",time:l},...m,{type:"round-end",time:f}].map(a=>y(R({},a),{time:a.time-l}))}function P(t,e){const n=t.match(/ *(\d*:\d*) (D|K);(.*);.*;.*;.*;(.*);.*;.*;.*;(.*);(.*);(.*);(.*)/);if(!n)return null;const[,s,r,c,i,l,f,m,a]=n,p=g(s),h=e.find(({guid:w})=>w===c),_=e.find(({guid:w})=>w===i);let T=l;m==="MOD_MELEE"&&!["combat_knife_mp","riotshield_mp"].includes(T)&&(T="melee_mp");const D=[{type:"damage",time:p,victim:h,attacker:_,damage:Number(f),weapon:T,means:m,hitLoc:a}];return r==="K"&&D.push({type:"death",time:p,victim:h,attacker:_,damage:Number(f),weapon:T,means:m,hitLoc:a}),D}function A(t,e){const n=t.match(/ *(\d*:\d*) TTT_ITEM_BOUGHT;(.*);.*;.*;(.*)/);if(!n)return null;const[,s,r,c]=n,i=e.find(l=>l.guid===r);return{type:"item-buy",time:g(s),player:i,item:c}}function G(t,e,n){const s=t.match(/ *(\d*:\d*) say;(.*?);.*?;.*?;(.*)/);if(!s)return null;const[,r,c,i]=s,l=e.find(a=>a.guid===c)||n.get(c)||{guid:c},f=i[0]===""?"quickmessage":"chat",m=["",""].includes(i[0])?i.slice(1):i;return{type:"say",time:g(r),player:l,message:m,messageType:f}}self.onmessage=async({data:{url:t}})=>{self.postMessage({status:"fetch",message:"Downloading Logfile"});const e=await o(t);self.postMessage({status:"parse",message:"Parsing Data",progress:"Preparing"});const n=u(e),s=v(n),r=k(n),i=d(r,Math.max(r.length/100,8)).reduce((f,m,a,{length:p})=>{const h=(a+1)/(p||1);return self.postMessage({status:"parse",progress:(h*100).toFixed()+"%"}),f.concat(b(m,s))},[]);self.postMessage({status:"parse",progress:"Cleaning up"});const l=L(i);self.postMessage({status:"done",data:{rounds:l,playerMap:s}})},self.addEventListener("unhandledrejection",t=>{throw t.preventDefault(),t.reason})})();
