(()=>{var L=Object.defineProperty,P=Object.defineProperties;var k=Object.getOwnPropertyDescriptors;var R=Object.getOwnPropertySymbols;var I=Object.prototype.hasOwnProperty,B=Object.prototype.propertyIsEnumerable;var N=(u,i,m)=>i in u?L(u,i,{enumerable:!0,configurable:!0,writable:!0,value:m}):u[i]=m,p=(u,i)=>{for(var m in i||(i={}))I.call(i,m)&&N(u,m,i[m]);if(R)for(var m of R(i))B.call(i,m)&&N(u,m,i[m]);return u},h=(u,i)=>P(u,k(i));(function(){"use strict";function u(n){const[t,e]=n.split(":");return Number(t)*60+Number(e)}function i(n){const t=n.match(/\n *\d*:\d* TTT_ROUND_START;(\d+)/);return t?new Date(Number(t[1])*1e3):null}function m(n,t){const e=n.match(/\n *\d*:\d* TTT_PLAYERS;(.*)\n/);return e?e[1].split(";").map(s=>{const[,c,a]=s.match(/(.*)<(.*)>/);return h(p({},t.get(c)),{role:a})}):[]}function E(n){const t=n.match(/\n *\d*:\d* TTT_ROUND_END;(.*?);(.*?);(.*);*/);if(!t)return null;const[,e,s,c]=t;return{winner:e,reason:s,roundLength:Number(c)}}function M(n,t){const e=n.match(/ *(\d*:\d*) (D|K);(.*);.*;.*;.*;(.*);.*;.*;.*;(.*);(.*);(.*);(.*)/);if(!e)return null;const[,s,c,a,r,d,f,l,o]=e,y=u(s),_=t.find(({guid:T})=>T===a),w=t.find(({guid:T})=>T===r);let g=d;l==="MOD_MELEE"&&!["combat_knife_mp","riotshield_mp"].includes(g)&&(g="melee_mp");const D=[{type:"damage",time:y,victim:_,attacker:w,damage:Number(f),weapon:g,means:l,hitLoc:o}];return c==="K"&&D.push({type:"death",time:y,victim:_,attacker:w,damage:Number(f),weapon:g,means:l,hitLoc:o}),D}function O(n,t){const e=n.match(/ *(\d*:\d*) TTT_ITEM_BOUGHT;(.*);.*;.*;(.*)/);if(!e)return null;const[,s,c,a]=e,r=t.find(d=>d.guid===c);return{type:"item-buy",time:u(s),player:r,item:a}}function b(n,t,e){const s=n.match(/ *(\d*:\d*) say;(.*?);.*?;.*?;(.*)/);if(!s)return null;const[,c,a,r]=s,d=t.find(o=>o.guid===a)||e.get(a)||{guid:a},f=r[0]===""?"quickmessage":"chat",l=["",""].includes(r[0])?r.slice(1):r;return{type:"say",time:u(c),player:d,message:l,messageType:f}}function v(n,t,e){const s=n.match(/\n *(\d*:\d*) TTT_ROUND_START.*\n((?:.|\n)*?)\n *(\d*:\d*) TTT_ROUND_END/);if(!s)return null;const[,c,a,r]=s,d=u(c),f=u(r),l=a.split(`
`).map(o=>M(o,t)||O(o,t)||b(o,t,e)||null).filter(o=>o).flat(1);return[{type:"round-start",time:d},...l,{type:"round-end",time:f}].map(o=>h(p({},o),{time:o.time-d}))}function G(n){return n.replace(/\^[\d:;]/g,"")}function S(n){const t=new Map,e=[...n.matchAll(/\n *\d*:\d* J;(.*?);.*?;(.*)/g)];for(const[,s,c]of e)t.set(s,{guid:s,name:G(c).trim(),isBot:s.length!==16});return t}async function U(n){return await(await fetch(n)).text()}function A(n){return new Promise(t=>{let e=n.replaceAll("\r","");e=e.replace(/.* -{20,}\n.*InitGame\n.*TTT_ROUND_START.*\n.*TTT_ROUND_END.*(?:.|\n)*?.*ShutdownGame.*\n.*-{20,}\n/g,"");const s=S(e),c=e.match(/\d*:\d* InitGame(?:.|\n)*?ShutdownGame/g).map(a=>{const r=m(a,s);return{date:i(a),players:r,outcome:E(a),events:v(a,r,s)}}).filter(({players:a,outcome:r})=>a.length&&r).filter(({players:a})=>a.every(({isBot:r})=>!r));t({playerMap:s,rounds:c})})}self.onmessage=async({data:{url:n}})=>{self.postMessage({status:"fetch"});const t=await U(n);self.postMessage({status:"parse"});const e=await A(t);self.postMessage({status:"done",data:e})}})();})();
